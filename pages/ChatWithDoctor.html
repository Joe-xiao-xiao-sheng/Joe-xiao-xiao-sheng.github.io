<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>立即问诊</title>
		<link rel="stylesheet" href="../CSS/Header.css" />
		<link rel="stylesheet" href="../plugins/elementui/index.css"/>
		<link rel="stylesheet" href="../plugins/font-awesome/css/font-awesome.css"/>
		<script src="../script/vue.js"></script>
		<script src="../script/Header.js"></script>
		<script src="../plugins/elementui/index.js"></script>
	</head>
	<body>
		<div id="Header" style="width: 100%;">
			<div id="iconBox">
				<img src="../img/logo.png" />
			</div>
			<ul id="items">
				<li class="item_li" ><a href="userIndex.html">首页</a></li>
				<li class="item_li" ><a href="QuickConsultation.html"  style="color: #ffd04b;">立即就诊</a></li>
			</ul>
			<div id="user" onclick="getUserDetail()">
				<p id="username"></p>
				<img src="../img/headerImage.png" />
			</div>
		</div>
		
		<div id="contain" style="width: 100%;display: flex;justify-content: center;margin-top: 1%;">
			<div id="leftContain" style="width: 20%;height: 37.5rem; margin-right: 5%; background-color: #D9FFFF;">
				<div style="padding: 0.625rem; border-bottom: 0.0625rem solid #F0F0F0;" class="departementLine" align="center">询问医生</div>
			</div>
			
			<div id="rightContain" style="width: 60%;height: 37.5rem;background-color: #D9FFFF;">
				
				<!-- <input type="text" v-model="userId" /><button @click="connection()">建立连接</button>
				<span>发送给</span><input type="text" v-model="sendObject.toUserId" />
				<input v-model="sendObject.message"></span>
				<button @click="sendMessage()">发送</button>
				<span v-text="getMessage"></span> -->
				
				<div id="chat">
					<div id="record" style="overflow-y: auto;" >
						<div class="historyLine">
							<img src="../img/doctor.png" align="top" />
							<span>你好！</span>
						</div>
					</div>
					<div></div>
					<div id="write">
						<input type="text" id="chatInput" v-model="sendObject.message" style="overflow-y: auto;" ></input>
						<el-button class="elbutton" id="sendButton" @click="sendMessage()">发送</el-button>
					</div>
				</div>
				
			</div>
		</div>
		<script>
			var app = new Vue({
				el:"#contain",
				data(){
					return {
						userId:"",
						socket:null,
						getMessage:"",
						sendObject:{
							toUserId:"",
							message:""
						}
						
					}
				},
				created() {
					var user = JSON.parse(sessionStorage.getItem("user"));
					if(user == null) {
						alert("请先登录")
						window.location.href = "Login.html";
					}
					
					console.log( this.sendObject == null )
					// console.log( app.sendObject == null )
					this.sendObject.toUserId = user.doctorId;
				},
				methods:{
					connection: function(){
						if('WebSocket' in window){
							// 创建WebSocket,尝试连接
							app.socket = new WebSocket("ws://localhost:8081/websocket/" + JSON.parse(sessionStorage.getItem("user")).userId);
							console.log(JSON.stringify(app.socket));
						}
						else{
							alert("当前浏览器不支持WebSocket")
							return ;
						}
						
						// 成功建立连接后调用
						app.socket.onopen = function(){
							console.log("成功建立连接");
						}
						
						// 接收到服务器返回信息时调用
						app.socket.onmessage = function(event){
							app.getMessage = JSON.parse(event.data).message;
							console.log(event.data);
							var url = "../img/doctor.png";
							var text = app.getMessage;
							text = app.getMessage;
							var div = document.createElement("div");
							div.className = "historyLine";
							var img = document.createElement("img");
							img.src = url;
							img.align = "top";
							var span = document.createElement("span");
							span.innerText = text;
							div.appendChild(img);
							div.appendChild(span);
							document.getElementById("record").appendChild(div);
						}
						
						// 服务器出现异常时调用
						app.socket.onerror = function(){
							console.log("服务器异常！请稍后再试");
						}
						
						// 连接断开时调用
						app.socket.onclose = function(){
							console.log("连接断开");
						}
						
					},
					sendMessage: function(){
						if(app.socket != null && app.sendObject.message != ""){
							console.log(JSON.stringify(app.socket))
							app.socket.send(JSON.stringify(app.sendObject));
							var url = "../img/user.png";
							var text = app.sendObject.message;
							var div = document.createElement("div");
							div.className = "historyLine";
							div.style = "justify-content: flex-end;";
							var img = document.createElement("img");
							img.src = url;
							img.align = "top";
							var span = document.createElement("span");
							span.innerText = text;
							div.appendChild(span);
							div.appendChild(img);
							document.getElementById("record").appendChild(div);
						}
						else{
							alert("请先建立连接并且输入需要发送的内容");
							return ;
						}
					}
				}
			})
			
			// 当前页面关闭前执行
			window.onbeforeunload = function(){
				if(app.socket != null){
					app.socket.close();
				}
			}
			
			window.onload = function(){
				app.connection()
			}
		</script>
		
		
		<style>
			#record{
				height: 28rem;
				border: solid 0.0625rem #d0d0d0;
			}
			.historyLine{
				margin: 0.3125rem;
				display: flex;
				width: 98%;
			}
			.historyLine img{
				display: block;
				position: relative;
				width: 5%;
				height: 5%;
			}
			.historyLine span{
				display: block;
				overflow: auto;
				position: relative;
				padding: 0.325rem;
				width: auto;
				border: solid #333333 0.0625rem;
			}
			#chat{
				margin-top: 5%;
				width: 90%;
				margin-left: 5%;
			}
			#chatInput{
				width: 80%;
				margin-left: 2%;
				height: 2rem;
				display: inline-block;
				position: relative;
				top: 0.9rem;
			}
			#sendButton{
				position: relative;
				top: 0.9375rem;
				margin-left: 5%;
			}
			.departementLine:hover{
				cursor: pointer;
				background-color: #00FFFF;
			}
		</style>
	</body>
</html>
