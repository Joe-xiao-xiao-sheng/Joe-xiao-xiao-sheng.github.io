<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<title>List</title>
		<!-- 引入样式 -->

		<link rel="stylesheet" href="../plugins/elementui/index.css">
		<link rel="stylesheet" href="../plugins/font-awesome/css/font-awesome.min.css">
		<link rel="stylesheet" href="../CSS/Header.css" />
		<link rel="stylesheet" href="../CSS/information.css" />
		<script src="../script/information.js"></script>
		<script src="../script/vue.js"></script>
		<script src="../plugins/elementui/index.js"></script>

	</head>

	<body>
		<div id="Header" style="width: 100%;">
			<div id="iconBox">
				<img src="../img/logo.png" />
			</div>
			<div id="items">
				<h2>用户中心</h2>
			</div>
			<div id="user">
				<p id="username"></p>
				<img src="../img/headerImage.png" />
			</div>
		</div>
		<div id="contain">
			<div id="leftContain">
				<ul id="menu">
					<li><a href="doctorInformation.html"> 更改个人信息 </a></li>
					<li style="background-color: #00FFFF;"><a href="patientList.html"> 查看病人列表 </a></li>
					<li><a href="#"> 更改电子病例 </a></li>
					<li><a href="#"> 编写诊断报告 </a></li>
					<li><a href="index.html">返回首页</a></li>
					<li><a href="#" id="loginOut" onclick="loginOut()"> 退出登录 </a></li>
				</ul>
			</div>
			<div id="rightContain">
				<div class="content-header">
					<h2>患者管理</h2>
				</div>
				<div class="app-container">
					<div class="box">
						<div class="filter-container">
							<el-input placeholder="患者名称" style="width: 200px;" class="filter-item"></el-input>
							<el-input placeholder="患者ID" style="width: 200px;" class="filter-item"></el-input>
							<el-button @click="getAll()">查询</el-button>
						</div>
						<el-table :data="userList" style="width: 100%"  size="medium ">
						    <el-table-column prop="userId" label="ID" width="180" align="center"></el-table-column>
						    <el-table-column prop="name" label="姓名" width="180"  align="center"></el-table-column>
						    <el-table-column prop="disease" label="疾病"  width="180"  align="center"> </el-table-column>
							<el-table-column prop="symptom" label="症状"  align="center"> </el-table-column>
							<el-table-column label="操作" width="150" align="center">
							      <template slot-scope="scope" >
							        <el-button @click="handleClick(scope.row)" type="text" size="small">查看详细信息</el-button>
									<el-badge :value="2" class="item" type="warning">
									  <el-button size="small" @click="openChat(scope.row)">回复</el-button>
									</el-badge>
							      </template>
							</el-table-column>
							<!-- <div id="Header" style="display: flex;">
								
							</div> -->
						</el-table>
					</div>
					
					<el-dialog title="聊天框" :visible.sync="dialogChatVisible" @opened="flushHistory()">
						<div id="chat">
							<div id="record" style="overflow-y: auto;" >
								<div class="historyLine">
									<img src="../img/user.png" align="top" />
									<span>你好！</span>
								</div>
							</div>
							<div></div>
							<div id="write">
								<input type="text" id="chatInput" v-model="sendObject.message" style="overflow-y: auto;" ></input>
								<el-button class="elbutton" id="sendButton" @click="sendMessage()">发送</el-button>
							</div>
						</div>
					</el-dialog>
					
					
				</div>
			</div>
		</div>
	</body>

	<!-- 引入组件库 -->
	<script>
		var main = new Vue({
			el: '#rightContain',
			data() {
				return {
				  userList: [{userId:"123",name:"Joe",disease:"脊椎损伤",symptom:"。。。"},
				  {userId:"2233",name:"Jack",disease:"腰结石",symptom:"暂无"}],
				  dialogChatVisible:false,
				  getMessage:"",
				  userChatMap: new Map(),
				  sendObject:{
					  toUserId:"",
					  message:""
				  } 	
				}
			},
			created() {
				var user = JSON.parse(sessionStorage.getItem("user"));
				if(user != null && user.doctorId != null)
				{
					fetch("http://localhost:8081/users/userList?doctorId=" + user.doctorId,{
						method: 'GET',
						headers:{
							'Content-Type': 'application/json'
						}
					}).then(resp => {
						if(resp.ok) return resp.json()
						else throw new Error("请求错误,请检查网络信息")
					}).then(data => {
						if(data.success == false){
							alert("获取病人列表失败")
							return ;
						}
						main.userList = data.data;
						for(var i = 0; i < main.userList.length; i++){
							main.userChatMap.set(main.userList[i].userId,[]);
						}
					})
				}
				else{
					alert("请先登录！");
					window.location.href = "Login.html";
				}
			},
			methods: {
				handleClick: function(row){
					console.log(row);
				},
				openChat: function(user){
					this.dialogChatVisible = true;
					main.sendObject.toUserId = user.userId;
					
				},
				connection: function(){
					if('WebSocket' in window){
						// 创建WebSocket,尝试连接
						main.socket = new WebSocket("ws://localhost:8081/websocket/" + JSON.parse(sessionStorage.getItem("user")).doctorId);
						console.log(JSON.stringify(main.socket));
					}
					else{
						alert("当前浏览器不支持WebSocket")
						return ;
					}
					
					// 成功建立连接后调用
					main.socket.onopen = function(){
						console.log("成功建立连接");
					}
					
					// 接收到服务器返回信息时调用
					main.socket.onmessage = function(event){
						var messageObject = JSON.parse(event.data);
						console.log(JSON.stringify(messageObject))
						// 先判断聊天窗口是否为打开状态
						if(!main.dialogChatVisible)	{
							var list = main.userChatMap.get(messageObject.fromUserId);
							if(list == null)	{
								main.userChatMap.set(messageObject.fromUserId,[])
								list = main.userChatMap.get(messageObject.fromUserId);
							}
							list.push(messageObject.message);
						}
						else{
							if(messageObject.fromUserId == main.sendObject.toUserId){
								main.addHistoryLine(messageObject.message);
							}
							else{
								var list = main.userChatMap.get(messageObject.fromUserId);
								if(list == null)	{
									main.userChatMap.set(messageObject.fromUserId,[])
									list = main.userChatMap.get(messageObject.fromUserId);
								}
								list.push(messageObject.message);
							}
						}
						// 如果为关闭状态则全部添加到 Map 集合中，如果已经打开，则判断当先接收信息是否为已经打开的窗口的人发送的信息
						// 如果是，则直接添加到 历史对话 ，如果不是，也添加到 Map 集合中
						
						// main.getMessage = JSON.parse(event.data).message;
						// console.log(event.data);
						
					}
					
					// 服务器出现异常时调用
					main.socket.onerror = function(){
						console.log("服务器异常！请稍后再试");
					}
					
					// 连接断开时调用
					main.socket.onclose = function(){
						console.log("连接断开");
					}
					
					
				},
				sendMessage: function(){
					if(main.socket != null && main.sendObject.message != ""){
						console.log(JSON.stringify(main.socket))
						main.socket.send(JSON.stringify(main.sendObject));
						var url = "../img/doctor.png";
						var text = main.sendObject.message;
						var div = document.createElement("div");
						div.className = "historyLine";
						div.style = "justify-content: flex-end;";
						var img = document.createElement("img");
						img.src = url;
						img.align = "top";
						var span = document.createElement("span");
						span.innerText = text;
						div.appendChild(span);
						div.appendChild(img);
						document.getElementById("record").appendChild(div);
					}
					else{
						alert("请先建立连接并且输入需要发送的内容");
						return ;
					}
				},
				
				addHistoryLine: function(message){
					var url = "../img/user.png";
					var text = main.ask;
					text = message;
					var div = document.createElement("div");
					div.className = "historyLine";
					var img = document.createElement("img");
					img.src = url;
					img.align = "top";
					var span = document.createElement("span");
					span.innerText = text;
					div.appendChild(img);
					div.appendChild(span);
					document.getElementById("record").appendChild(div);
					
				},
				flushHistory: function(){
					// 当打开一个对话框的时候，需要判断 Map 中与该用户的message列表长度是否为 0
					var list = main.userChatMap.get(main.sendObject.toUserId);
					console.log("list == null ? " + list == null)
					
					if(list == null) {
						main.userChatMap.set(main.sendObject.toUserId,[])
						list = main.userChatMap.get(main.sendObject.toUserId);
					}
					console.log("list.length == 0 ? " + list.length == 0)
					// 如果不是 0 ，则将列表中的数据添加到 History 中，之后 再将列表清空
					while(list.length > 0){
						// shift 返回并删除第一个元素
						console.log("#####")
						var message = list.shift();
						console.log("message :" + message)
						main.addHistoryLine(message);
					}
				}
			}
		})
		
		window.onload = function(){
			main.connection();
		}
	</script>


	<style>
		#record{
			height: 28rem;
			border: solid 0.0625rem #d0d0d0;
		}
		.historyLine{
			margin: 0.3125rem;
			display: flex;
			width: 98%;
		}
		.historyLine img{
			display: block;
			position: relative;
			width: 5%;
			height: 5%;
		}
		.historyLine span{
			display: block;
			overflow: auto;
			position: relative;
			padding: 0.325rem;
			width: auto;
			border: solid #333333 0.0625rem;
		}
		#chat{
			margin-top: 5%;
			width: 90%;
			padding-right: 1%;
		}
		#chatInput{
			width: 80%;
			margin-left: 2%;
			height: 2rem;
			display: inline-block;
			position: relative;
			top: 0.9rem;
		}
		#sendButton{
			position: relative;
			top: 0.9375rem;
			margin-left: 5%;
		}
	</style>
</html>

